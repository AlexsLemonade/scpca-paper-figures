---
title: "Compare ESTIMATE results to consensus cell types"
author: "Stephanie J. Spielman"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_depth: 3
    code_folding: hide
---

The purpose of this notebook is to compare ESTIMATE scores to consensus cell types.

## Setup


```{r setup}
renv::load()

library(ggplot2)
theme_set(theme_bw())
options(readr.show_col_types = FALSE)
```

### Paths

```{r paths}
data_dir <- here::here("analysis", "estimate", "data")
celltype_dir <- file.path(data_dir, "consensus-celltypes")

library_metadata_file <- here::here("s3_files", "scpca-library-metadata.tsv")
estimate_file <- here::here("analysis", "estimate", "results", "estimate_results.tsv")
immune_celltypes_groups_url <- "https://raw.githubusercontent.com/AlexsLemonade/OpenScPCA-analysis/refs/heads/main/analyses/cell-type-consensus/references/consensus-immune-cell-types.tsv"


# we'll name these by library id to start, and then swap to sample later
celltype_files <- list.files(
  celltype_dir, 
  pattern = "_processed_consensus-cell-types\\.tsv\\.gz$", 
  full.names = TRUE, 
  recursive = TRUE
) |>
    purrr::set_names(
    \(x) {stringr::str_split_i(basename(x), pattern = "_", i = 1)}
  )
```

### Read input data

```{r warning = FALSE}
estimate_df <- readr::read_tsv(estimate_file)
library_metadata_df <- readr::read_tsv(library_metadata_file)

id_df <- estimate_df |>
  dplyr::inner_join(
    library_metadata_df |>
      dplyr::filter(seq_unit %in% c("cell", "nucleus")) |>
      dplyr::select(scpca_sample_id, scpca_library_id),
    by = c("sample_id" = "scpca_sample_id")
  ) |>
  dplyr::select(project_id, sample_id, library_id = scpca_library_id) |>
  dplyr::distinct()

library_sample_c <- id_df$sample_id |>
  purrr::set_names(id_df$library_id)

celltype_data <- celltype_files |>
  # only keep libraries of interest
  purrr::keep_at(
    \(library_id) library_id %in% names(library_sample_c)
  ) |> 
  purrr::map(
    \(f) {
      readr::read_tsv(f) |>
        dplyr::select(project_id, sample_id, consensus_annotation, consensus_ontology)
  })

# update names to sample ids
sample_names <- library_sample_c[names(celltype_data)] |> unname()
names(celltype_data) <- sample_names

immune_df <- readr::read_tsv(immune_celltypes_groups_url)
```

### Define cell type groups

First, what cell types do we have for this data?
For human readability, we'll look at the annotations, not ontologies, for this.

```{r}
all_celltypes <- celltype_data |>
  purrr::map(
    \(cell_df) dplyr::pull(cell_df, consensus_annotation) |> unique()
  ) |>
  purrr::reduce(union)

all_celltypes
```

* We can use the `celltype_validation_groups` data frame to identify immune cells to use in comparisons
* For stromal cells, since ESTIMATE defines stromal as non-cancer and non-immune (aka "everything else"), we'll define all non-immune and non-neural cell types as stromal
  * An important caveat to bear in mind that is that two of our projects, SCPCP000006 (Wilms tumor) and SCPCP000017 (osteosarcoma), will have cancer cell types with a high degree of similarity to several stromal cell types, which can make teasing these categories apart challenging

```{r}
stromal_celltypes <- c(
  "chondrocyte", 
  "adipocyte", 
  "endothelial cell",
  "epithelial cell",               # TODO: include?
  "smooth muscle cell", 
  "muscle cell", 
  "blood vessel endothelial cell", # TODO: include?
  "stromal cell", 
  "pericyte",                      # TODO: include?
  "mesangial cell", 
  "fibroblast"
)

immune_celltypes <- immune_df$consensus_annotation
```
  
The following consensus cells are not currently included in this analysis:

```{r}
all_celltypes[!(all_celltypes %in% c(stromal_celltypes, immune_celltypes))]
```

## Cell type group counts

Next, we'll calculate proportions of these cell types across samples.

```{r}
celltype_category_df <- celltype_data |>
  purrr::map(
    \(cell_df) {
        cell_df |>
        dplyr::mutate(
          estimate_category = dplyr::case_when(
            consensus_annotation %in% immune_celltypes ~ "immune",
            consensus_annotation %in% stromal_celltypes ~ "stromal", 
            .default = "other"
          )) |>
        dplyr::count(estimate_category) |>
        dplyr::mutate(frac = n/sum(n)) |>
        dplyr::select(-n)
    }
  ) |>
  purrr::list_rbind(names_to = "sample_id") |>
  # we need to add in project ids
  dplyr::inner_join(dplyr::select(id_df, project_id, sample_id)) |>
  dplyr::mutate(estimate_category = forcats::fct_relevel(estimate_category, "immune", "stromal", "other"))
```

What do we have?


```{r fig.height=12, fig.width=8}
ggplot(celltype_category_df) + 
  aes(x = sample_id, y = frac, fill = estimate_category) +
  geom_col() + 
  scale_fill_brewer(palette = "Set2") + 
  facet_wrap(vars(project_id), scales = "free", ncol = 1) + 
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "fraction of cells in sample") +
  theme(axis.text.x = element_blank()) 
```


* Nearly all samples across SCPCP000001, SCPCP000002, and SCPCP000006 lack "stromal cells" 
  * From the plot, it appears only 1 sample in SCPCP000001 and 1 sample in SCPCP000006 have stromal; if other samples have, it's an exceedingly small proportion
* Only SCPCP000006 and SCPCP000009 have samples with truly visible levels of "stromal cells", particularly SCPCP000009
  * It is more challenging in these cancer types (wilms and osteo, respectively) to distinguish among stromal and cancer cells get, so the stromal proportions here are not necessarily definitive

## Relationship between cell types and pseudobulk ESTIMATE scores

Next, we'll directly look at the relationships between fractions of these cell type groups and ESTIMATE scores.
We'll do this now with pseudobulk ESTIMATE scores, which is from the same underlying modality as the consensus cell types.

```{r}
wide_category_df <- celltype_category_df |>
  dplyr::mutate(estimate_category = glue::glue("celltype_{estimate_category}")) |>
  tidyr::pivot_wider(
    names_from = estimate_category, 
    values_from = frac, 
    values_fill = 0
  )
  
  
combined_wide_df <- estimate_df |>
  dplyr::filter(expression_type == "pseudobulk") |>
  dplyr::select(-expression_type) |>
  dplyr::mutate(score_type = glue::glue("estimate_score_{score_type}")) |>
   tidyr::pivot_wider(
    names_from = score_type, 
    values_from = score
  ) |>
  dplyr::left_join(wide_category_df)
```

```{r, fig.height = 3, fig.width=12}
ggplot(combined_wide_df) + 
  aes(x = estimate_score_immune, y = celltype_immune) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(vars(project_id), scales = "free_y", nrow = 1) +
  labs(
    title = "Immune celltypes", 
    x = "ESTIMATE immune score (pseudobulk)", 
    y = "Immune cell fraction in consensus celltypes"
  )
```


```{r, fig.height = 3, fig.width=12}
ggplot(combined_wide_df) + 
  aes(x = estimate_score_stromal, y = celltype_stromal) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(vars(project_id), scales = "free_y", nrow = 1) +
  labs(
    title = "Stromal celltypes", 
    x = "ESTIMATE stromal score (pseudobulk)", 
    y = "Stromal cell fraction in consensus celltypes"
  )
```

* Immune plots:
  * SCPCP000001, SCPCP00006, and SCPCP000017 show a positive relationship between quantities
  * There is no apparent relationship for SCPCP000002 or SCPCP000009
* Stromal plots:
  * SCPCP00006 and SCPCP000017 show a positive relationship between quantities
  * There is no apparent relationship for SCPCP000001, SCPCP000002, or SCPCP000009


### Relationship between `Unknown` and tumor purity

In theory, the `Unknown` cells in our consensus annotation are more likely to be tumor cells.
Similarly in theory, the ESTIMATE score (sum of immune and stromal) is expected to be proportional to tumor purity.

Is there a relationship between these quantities?

```{r, fig.height = 3, fig.width=12, message = FALSE}
unknown_df <- celltype_data |>
  purrr::map(
    \(cell_df) {
        cell_df |>
          # group to keep these columns
          dplyr::group_by(sample_id, project_id) |>
          dplyr::summarize(
            is_unknown = sum(consensus_annotation == "Unknown"), 
            frac_unknown = is_unknown / dplyr::n()
          )
    }
  ) |>
  purrr::list_rbind(names_to = "sample_id") |>
  dplyr::inner_join(combined_wide_df) |>
  dplyr::mutate(estimate_score = estimate_score_stromal + estimate_score_immune)

ggplot(unknown_df) + 
  aes(x = estimate_score, y = frac_unknown) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(~project_id)
```
There isn't really a relationship here.


## Relationship between cell types and bulk ESTIMATE scores

We'll do the same comparisons here but with ESTIMATE scores estimated from bulk counts (not bulk TPM) instead of from pseudobulk.

```{r}
combined_wide_df <- estimate_df |>
  dplyr::filter(expression_type == "bulk_counts") |>
  dplyr::select(-expression_type) |>
  dplyr::mutate(score_type = glue::glue("estimate_score_{score_type}")) |>
   tidyr::pivot_wider(
    names_from = score_type, 
    values_from = score
  ) |>
  dplyr::left_join(wide_category_df)
```


```{r, fig.height = 3, fig.width=12}
ggplot(combined_wide_df) + 
  aes(x = estimate_score_immune, y = celltype_immune) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(vars(project_id), scales = "free_y", nrow = 1) +
  labs(
    title = "Immune celltypes", 
    x = "ESTIMATE immune score (bulk)", 
    y = "Immune cell fraction in consensus celltypes"
  )

ggplot(combined_wide_df) + 
  aes(x = estimate_score_stromal, y = celltype_stromal) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(vars(project_id), scales = "free_y", nrow = 1) +
  labs(
    title = "Stromal celltypes", 
    x = "ESTIMATE stromal score (bulk)", 
    y = "Stromal cell fraction in consensus celltypes"
  )
```

Trends are mostly the same here, except there is no relationship for stromal with SCPCP000017 with bulk-derived ESTIMATE scores as there was for pseudobulk.



Is there a relationship between unknown and 

```{r, fig.height = 3, fig.width=12, message = FALSE}
unknown_df <- celltype_data |>
  purrr::map(
    \(cell_df) {
        cell_df |>
          # group to keep these columns
          dplyr::group_by(sample_id, project_id) |>
          dplyr::summarize(
            is_unknown = sum(consensus_annotation == "Unknown"), 
            frac_unknown = is_unknown / dplyr::n()
          )
    }
  ) |>
  purrr::list_rbind(names_to = "sample_id") |>
  dplyr::inner_join(combined_wide_df) |>
  dplyr::mutate(estimate_score = estimate_score_stromal + estimate_score_immune)

ggplot(unknown_df) + 
  aes(x = estimate_score, y = frac_unknown) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(~project_id)
```

Again, there is no relationship here. 

## Session info

```{r}
sessionInfo()
```