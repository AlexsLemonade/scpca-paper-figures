---
title: "Explore EPIC results and identify a reference"
author: Stephanie J. Spielman
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_depth: 3
    code_folding: show
---

The goal of this notebook is to explore the `EPIC` results and identify whether we should use inferences from `TRef` or `BRef` reference moving forward. 
These two distinct references estimate the proportions of the following cell types (note they use these strings, not ontologies), where I have bolded the cell types they share:

- The `TRef` reference (7 + other):
  - **`Bcells`**    
  - `CAFs` (cancer-associated fibroblasts)
  - **`CD4_Tcells`**
  - **`CD8_Tcells`**
  - `Endothelial`
  - `Macrophages`
  - **`NKcells`**
  - `otherCells`
- The `BRef` reference (6 + other):
  - **`Bcells`**   
  - **`CD4_Tcells`**
  - **`CD8_Tcells`**
  - `Monocytes`
  - `Neutrophils`
  - **`NKcells`**
  - `otherCells`
          
Notably, `TRef` includes fibroblasts and epithelial cells, which we are interested in being able to quantify!

This notebook also assumes the ScPCA sample metadata is available in, relative to the repository root,` s3_files/scpca-sample-metadata.tsv`.

## Setup

```{r setup, message = FALSE}
renv::load()

library(ggplot2)
library(patchwork)
theme_set(theme_bw())
```


### Functions

This chunk defines a helper function for making barplots to display cell types.

```{r make_barplot function}
#' Make a barplot of EPIC cell types using ggplot::geom_col()
#' 
#' Variables should be provided plain without quotes.
#'
#' @param df Data frame to plot
#' @param xvar Variables to place on x-axis
#' @param yvar Variable to place on y-axis
#' @param facetvar Variable to use for faceting with facet_wrap()
#' @param fillvar Variable to use for fill
#' @param plot_title String for plot title
#' @param color_map Vector mapping cell types to their color
#'
#' @returns ggplot object
make_epic_celltype_barplot <- function(df, xvar, yvar, facetvar, fillvar, plot_title, color_map) {
  
 ggplot(df) + 
   aes(x = {{xvar}}, y = {{yvar}}, fill = {{fillvar}}) +
   geom_col() + 
   facet_wrap(vars({{facetvar}}), scales = "free_x", nrow = 1) + 
   scale_y_continuous(expand = c(0,0)) +
   scale_fill_manual(values = color_map, na.value = "grey90", name = "cell type") +
   labs(title = plot_title) + 
   theme(axis.text.x = element_blank())
   
}

```

### Paths

```{r paths}
results_dir <- here::here("analysis", "bulk-deconvolution", "results")
sample_metadata_file <- here::here("s3_files", "scpca-sample-metadata.tsv") # for diagnosis

epic_files <- list.files(
  path = results_dir,
  full.names = TRUE,
  pattern = "*-epic.tsv$"
)
project_ids <- stringr::str_split_i(basename(epic_files), pattern = "-", i = 1)
epic_files <- setNames(epic_files, project_ids)
```

### Prepare input data

```{r read metadata}
# We want the diagnosis information for visualization
metadata <- readr::read_tsv(sample_metadata_file) |>
  dplyr::select(sample_id = scpca_sample_id, diagnosis)

```

```{r}
# Read in epic result TSVs and combine into single data frame
epic_df <- epic_files |>
  purrr::map(\(file) readr::read_tsv(file, show_col_types = FALSE)) |>
  purrr::list_rbind(names_to = "project_id") |>
  # include diagnosis information
  dplyr::left_join(metadata, by = "sample_id") |>
  # add indicator column if the celltype is "otherCells"
  dplyr::mutate(is_other = epic_celltype == "otherCells")
head(epic_df)
```

Below is a table with high-level diagnoses for each ScPCA project:


| Project     | High-level diagnosis |
|-------------|----------------------|
| SCPCP000001 | High-grade glioma    |
| SCPCP000002 | Low-grade glioma     |
| SCPCP000006 | Wilms tumor          |
| SCPCP000009 | CNS tumors           |
| SCPCP000017 | Osteosarcoma         |

For ease interpreting subsequent figures, we'll add these high-level diagnoses into the data frame with a project number indicator (excluding leading 0s).

```{r}
epic_df <- epic_df |>
  dplyr::mutate(
    project_diagnosis = dplyr::case_match(
      project_id, 
      "SCPCP000001" ~ "01: High-grade glioma", 
      "SCPCP000002" ~ "02: Low-grade glioma", 
      "SCPCP000006" ~ "06: Wilms tumor", 
      "SCPCP000009" ~ "09: CNS tumors", 
      "SCPCP000017" ~ "17: Osteosarcoma"
    ))

```

## Visualization

### Proportions of cell types

Considering all categories of cells, what proportions of cell types are represented across samples?


```{r fig.height=8, fig.width=16}
# First, we'll turn the otherCells level into `NA` for ease in coloring
epic_otherna_df <- epic_df |>
  dplyr::mutate(epic_celltype = ifelse(
    epic_celltype == "otherCells", 
    NA_character_, 
    epic_celltype
  ))


# Next, we'll define a vector of colors to use for plots which ensures that shared cell types have the same colors
# hex codes are (mostly) from Okabe-Ito
color_map <- c(
  # shared cell types
  "Bcells" = "#E69F00", 
  "CD4_Tcells" = "#56B4E9", 
  "CD8_Tcells" = "#009E73", 
  "NKcells" =  "#F0E442",
  # reference-specific cell types
  "CAFs" = "#0072B2",
  "Endothelial" = "#D55E00",
  "Macrophages" = "#CC79A7",
  "Monocytes" = "grey30", 
  "Neutrophils" = "grey60"
)  
celltype_levels <- c(names(color_map))
  
  
tref_barplot <- make_epic_celltype_barplot(
  epic_otherna_df |> dplyr::filter(reference == "TRef"),
  xvar = sample_id, 
  yvar = fraction, 
  facetvar = project_diagnosis,
  fillvar = forcats::fct_relevel(epic_celltype, celltype_levels),
  plot_title = "TRef reference", 
  color_map = color_map
) 
  
bref_barplot <- make_epic_celltype_barplot(
  epic_otherna_df |> dplyr::filter(reference == "BRef"),
  xvar = sample_id, 
  yvar = fraction, 
  facetvar = project_diagnosis,
  fillvar = forcats::fct_relevel(epic_celltype, celltype_levels),
  plot_title = "BRef reference", 
  color_map = color_map
) 

tref_barplot / bref_barplot
```

Generally speaking, `TRef` identifies more cell types compared to `BRef`, although whether it _should_ be classifying all those cells is an open question to bear in mind!

Let's compare the proportions of shared cell types inferred between references a bit closely with scatterplots:

```{r fig.width = 12, fig.height = 14}
shared_celltypes <- c("Bcells", "CD4_Tcells", "CD8_Tcells", "NKcells", "otherCells")


compare_reference_celltype <- function(celltype, epic_df) {
  epic_other_df <- epic_df |>
    dplyr::filter(epic_celltype == celltype) |>
    dplyr::select(project_diagnosis, sample_id, reference, fraction) |>
    dplyr::group_by(project_diagnosis, sample_id) |>
    tidyr::pivot_wider(
      names_from = reference, 
      values_from = fraction
    ) |>
    dplyr::mutate(higher_value = ifelse(BRef > TRef, "BRef", "TRef"))
  
  ggplot(epic_other_df) + 
    aes(x = TRef, y = BRef, color = higher_value) + 
    geom_point(alpha = 0.5) + 
    geom_abline() +
    labs(
      x = "TRef fraction",
      y = "BRef fraction", 
      title = celltype
    ) +
    facet_wrap(vars(project_diagnosis), nrow = 1)
}

shared_celltypes |>
  purrr::map(compare_reference_celltype, epic_df) |>
  patchwork::wrap_plots(nrow = length(shared_celltypes), guides = "collect")
```
From all above comparisons, we see these trends:

* `Bcell`, `CD4_Tcells`,  and `NKcell` proportions are roughly similar between references and low across all samples
  * In a handful of CNS tumor samples, `TRef` estimates higher `BCell` proportions
  * In a handful of CNS tumor samples, `TRef` estimates higher `BCell` proportions
  * It does look like `CD4_Tcells` estimates are a bit higher for `TRef`, but there are two osteosarcoma samples which show really high values from `BRef`
* `CD8_Tcells` are mostly similar with some additional trends:
  * Vaues are generally higher for `BRef` for Wilms Tumor samples
  * Values are generally higher for `TRef` and both CNS tumor and osteosarcoma samples
* As stated, `TRef` classifies more cells than does `BRef` for all but one osteosarcoma sample


**Based on these comparisons, we'll move forward with the `TRef` reference.**

```{r}
tref_df <- epic_df |>
  dplyr::filter(reference == "TRef")
```


Let's look at the samples had very few "other" cells:

```{r}
classified_samples <- tref_df |>
  dplyr::filter(is_other, fraction <= 0.1) |> 
  dplyr::pull(sample_id)

classified_samples_df <- tref_df |>
  dplyr::filter(sample_id %in% classified_samples) |>
  # add more detailed diagnosis for the non-osteo sample
  dplyr::mutate(sample_diagnosis = ifelse(
    project_id == "SCPCP000009", 
    glue::glue("{sample_id}\n({diagnosis})"), 
    sample_id)
  ) |>
  dplyr::select(
    project_diagnosis, 
    sample_diagnosis, 
    epic_celltype, 
    fraction) 

ggplot(classified_samples_df) + 
  aes(x = sample_diagnosis, y = fraction, fill = epic_celltype) +
  geom_col() + 
  scale_fill_manual(values = color_map, na.value = "grey90", name = "cell type") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) + 
  facet_wrap(vars(project_diagnosis), scales = "free_x")
```
* It does make sense that `CAFs` are dominating osteosarcoma samples (indeed they are prevalent, generally speaking, across a few more than these osteosarcoma samples) since we know they are a major component of osteosarcomas
  * Some of those cells may actually be tumor cells which `EPIC` misclassified
* It's worth noting that osteo sample dominated by `CD4 TCells` was also dominated by this cell type for the other `BRef` reference


### Number of identified cell types

Let's look at some associated summaries for this sample-specific information.

Of the 7 cell types in `TRef`, how many are represented in each sample?
For this, we'll make a histogram of the number of cell types identified per sample (regardless of their proportion).
Since, as it seems, EPIC generally doesn't estimate 0's, we'll instead provide a low threshold value of `1e-4` (artbitrarily chosen as low but not _too_ low!).

```{r}
celltype_counts_df <- tref_df |>
  dplyr::filter(!is_other) |>
  dplyr::group_by(project_diagnosis, sample_id) |>
  dplyr::summarize(num_celltypes = sum(fraction >= 1e-4))
```


```{r fig.height=4, fig.width=10}
ggplot(celltype_counts_df) + 
  aes(x = num_celltypes) + 
  geom_histogram(center = 0, binwidth = 1) + 
  scale_x_continuous(breaks = scales::breaks_pretty()) +
  facet_wrap(vars(project_diagnosis), nrow = 1) + 
  ggtitle("Number of cell types inferred in individual samples")
```  
We can also make an associated summary table:

```{r}
celltype_counts_df |>
  dplyr::group_by(project_diagnosis) |>
  dplyr::summarize(
    min_celltypes = min(num_celltypes), 
    median_celltypes = median(num_celltypes), 
    max_celltypes = max(num_celltypes), 
  )
```

Overall, we see that most all samples have at least 5-6 cell types, which is more than half of the possible cell types (there are seven total).


Next, in what proportion of samples is each cell type represented?
Again, this only considers cell type presence and absence at a `1e-4` threshold.

```{r}
# calculate number of celltypes per sample
samples_per_celltype_df <- epic_df |>
  dplyr::filter(!is_other) |>
  dplyr::mutate(celltype_present = fraction > 1e-4) |>
  dplyr::group_by(epic_celltype, project_diagnosis) |>
  dplyr::summarize(n_samples = sum(celltype_present)) 

# convert number to proportion
samples_per_celltype_df <- epic_df |>
  dplyr::filter(is_other) |>
  dplyr::count(project_diagnosis) |>
  dplyr::right_join(samples_per_celltype_df) |>
  dplyr::mutate(prop_samples = n_samples / n)
```

```{r fig.height=4, fig.width=12, message = FALSE}
ggplot(samples_per_celltype_df) + 
  aes(x = epic_celltype, y = prop_samples) + 
  geom_col() +
  geom_hline(yintercept = 0.5, color = "firebrick2") +
  facet_wrap(vars(project_diagnosis), nrow = 1) +
  # add guiding line at 0.5
  theme(axis.text.x = element_text(angle = 30, hjust = 1, size = rel(0.8))) + 
  ggtitle("Proportion of samples with each cell type")
```

* `NKcells` are not common in `SCPCP000002` or `SCPCP000009` and generally appear in the fewest samples
* Most samples contain `CD8` T cells, and `CD4` cells are also common but a bit less than `CD8`
* Except for `SCPCP000017`, most samples contain `BCells`

### Comparison with mRNAProportions


`EPIC` also provides an estimate for cell fractions without correcting for expected mRNA content among cell types; this setting is recommended for pseudobulk samples but not true bulk RNA-seq, so we didn't use it above.

Just to cover all bases though, let's do a quick comparison to see how different the values are. 
In the plot `corrected_fractions` corresponds to what we have been using; `uncorrected_fractions` corresponds to fractions which have not been corrected for mRNA content, i.e. the `mRNAProportions` quantity.

```{r fig.height=10}
tref_renamed_df <- tref_df |>
  dplyr::filter(!is_other) |>
  dplyr::select(project_diagnosis, epic_celltype, corrected_fractions = fraction, uncorrected_fractions = mRNAProportions)

ggplot(tref_renamed_df) +
  aes(x = corrected_fractions, y = uncorrected_fractions) + 
  geom_point() + 
  geom_abline(color = "blue") + 
  coord_equal() +
  facet_grid(
    rows = vars(epic_celltype), 
    cols = vars(project_diagnosis)
  )
```
Overall values seem highly similar, but we can see that `Macrophages` have been corrected to have slightly lower values.
A more in-depth comparison here might zoom in to axes and/or explore relative error between measurements, but that is beyond the scope of what we are interested in looking at which is just to peek and get a sense!

## Conclusions

Between the two `EPIC` references explored here, `TRef` seems more suited to our data since it contains some non-leukocyte normal cell types and does a more thorough job of classification.
That said, it is not clear whether it _should_ do a more thorough job of classification, and it is missing useful-to-have cell types `Monocytes` and `Neutrophils` which are in the `BRef` reference.

There are also samples which were nearly if not entirely fully classified, but many of these might be misclassifications due to biological similarity between fibroblasts and osteosarcoma cells. 


## Session info

```{r}
sessionInfo()
```