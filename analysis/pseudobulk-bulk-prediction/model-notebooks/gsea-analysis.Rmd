---
title: "GSEA analysis"
author: Stephanie J. Spielman
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_depth: 3
    code_folding: hide
params:
  project_id: "SCPCP000009"
---


## Setup

```{r setup}
renv::load()

library(ggplot2)
theme_set(theme_bw())
```


### Paths

```{r paths}
analysis_dir <- here::here("analysis", "pseudobulk-bulk-prediction")
model_file <- file.path(
  analysis_dir, 
  "results", 
  "models", 
  glue::glue("{params$project_id}_bulk-pseudobulk-model.rds")
)
```


Define files to read in:

```{r}
model_data <- readr::read_rds(model_file)

model_df <- model_data$data |>
  dplyr::mutate(residuals = unname(resid(model_data$model)))
sigma <- unname(model_data$model@devcomp$cmp["sigmaML"])

n_samples <- length(unique(model_data$data$sample_id))
```



## GSEA with Hallmark gene set

We'll explore the potential utility of using GSEA on residuals to identify biological patterns of outlier genes.
For this, we'll use the Hallmark gene set from `MSigDB`. 

```{r}
hallmark_df <- msigdbr::msigdbr(species = "Homo sapiens", category = "H") # 50 gene sets
```                     
                      
We'll run GSEA for each sample.    
                          
```{r, warning = FALSE, message = FALSE}
hallmark_gsea <- unique(model_df$sample_id) |> 
  purrr::set_names(unique(model_df$sample_id)) |>
  purrr::map(
    \(id) {
      # arrange *decreasing*
      ranked_residuals <- model_df |> 
        dplyr::filter(sample_id == id) |>
        dplyr::arrange(-residuals) |>
        dplyr::pull(residuals, name = ensembl_id)

      gsea_results <- clusterProfiler::GSEA(
        geneList = ranked_residuals, 
        TERM2GENE = dplyr::select(hallmark_df, gs_name, ensembl_gene)
      )
  })
```

Since we ran this for each sample, we'll be a little more stringent with P-values and look for significant gene sets where the adjusted P-value is less than `0.01 / <number of samples>`.

```{r}
threshold <- 0.01/n_samples

# Find significant gene sets, both positive and negative
sig_lists <- hallmark_gsea |>
  purrr::map(
    \(gsea_result) {
      
      sig_df <- gsea_result@result |>
        dplyr::filter(p.adjust <= threshold)
      
      list(
        neg = sig_df$ID[sig_df$NES < 0], 
        pos = sig_df$ID[sig_df$NES > 0] 
      )
    }
  )

# Pluck out negative and positive to look at them separately
neg_sig_lists <- sig_lists |> purrr::map(purrr::pluck, "neg")
pos_sig_lists <- sig_lists |> purrr::map(purrr::pluck, "pos")
```


How many gene signatures were identified in either direction per sample?


```{r}
# Count the number of positive and negatives per sample
gs_count_df <- purrr::map2(
  neg_sig_lists, 
  pos_sig_lists, 
  \(neg_gs, pos_gs) {
    
    data.frame(
      negative = length(neg_gs), 
      positive = length(pos_gs)
    )

  }) |>
  purrr::set_names(names(neg_sig_lists)) |>
  purrr::list_rbind(names_to = "sample_id") |>
  tidyr::pivot_longer(
    !sample_id, 
    names_to = "direction", 
    values_to = "n_gene_sets"
  )


# Barplot of counts per sample
ggplot(gs_count_df) + 
  aes(x = sample_id, y = n_gene_sets, fill = direction) + 
  geom_col(position = position_dodge()) +
  geom_text(
    aes(label = n_gene_sets, y = n_gene_sets + 1), 
    position = position_dodge(width = 1), 
    size = 2.5
  ) +
  scale_fill_brewer(palette = "Set2") + 
  labs(
    title = "Hallmark GSEA (n=50 genesets)", 
    y = "Number of significant genesets in sample"
  ) +
  scale_y_continuous(expand = c(0,1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, size = 8))

```

Determine logic for next sections:

```{r}
run_neg <- purrr::reduce(neg_sig_lists, c) |> length() |> as.logical()
run_pos <- purrr::reduce(pos_sig_lists, c) |> length() |> as.logical()
```


### Positive enrichment if present

```{r, eval = run_pos, fig.height = 8}
 UpSetR::upset(
   UpSetR::fromList(pos_sig_lists),
   order.by = "degree", # order columns by number of samples
   text.scale = 1.25,
   nsets = 100 # make sure all sets are plotted, not only top 5
  )
```

Those pathways are:
```{r, eval = run_pos}
pos_intersection <- pos_sig_lists |>
  purrr::reduce(intersect)
pos_intersection
```

We'll plot the first pathway for all samples if it exists.

```{r, eval = run_pos, fig.height = 4}
if (length(pos_intersection)>0) {
  plot_hallmark <- pos_intersection[1]
  print(plot_hallmark)
  hallmark_gsea |>
    purrr::iwalk(
      \(gsea_result, sample_id) {
        enrichplot::gseaplot(
          gsea_result,
          geneSetID = plot_hallmark,
          title = sample_id,
          color.line = "dodgerblue"
        ) |> print()
    })
}
```





### Negative enrichment if present

```{r, eval = run_neg, fig.height = 8}
 UpSetR::upset(
   UpSetR::fromList(neg_sig_lists),
   order.by = "degree", # order columns by number of samples
   text.scale = 1.25,
   nsets = 100 # make sure all sets are plotted, not only top 5
  )
```

Those pathways are:
```{r eval = run_neg}
neg_intersection <- neg_sig_lists |>
  purrr::reduce(intersect)
neg_intersection
```

We'll plot the first pathway for all samples if it exists.


```{r, eval = run_neg, fig.height = 4}
if (length(neg_intersection)>0) {
  plot_hallmark <- neg_intersection[1]
  print(plot_hallmark)
  hallmark_gsea |>
    purrr::iwalk(
      \(gsea_result, sample_id) {
        enrichplot::gseaplot(
          gsea_result,
          geneSetID = plot_hallmark,
          title = sample_id,
          color.line = "dodgerblue"
        ) |> print()
    })
}
```


## Session info

```{r}
sessionInfo()
```