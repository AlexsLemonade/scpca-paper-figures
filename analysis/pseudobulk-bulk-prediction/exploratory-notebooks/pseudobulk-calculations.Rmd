---
title: "Pseudobulk and bulk data distributions"
author: Stephanie J. Spielman
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_depth: 3
    code_folding: show
---

The goal of this notebook is to compare pseudobulk and bulk calculations to determine which pseudobulk calculation should we proceed with for modeling: the log2 of the sum of raw counts (`pseudobulk_log_counts`) or the `DESeq2`-normalized sum of raw counts (`pseudobulk_deseq`).
To this end, we'll visualize expression distributions, both on their own and compared to bulk TPM. 


## Setup

```{r setup}
renv::load()

library(ggplot2)
theme_set(theme_bw())
```

### Paths

```{r paths}
data_dir <- here::here("analysis", "pseudobulk-bulk-prediction", "data")
tpm_dir <- file.path(data_dir, "tpm")
pseudobulk_dir <- file.path(data_dir, "pseudobulk")


tpm_files <- list.files(
  path = tpm_dir,
  full.names = TRUE,
  pattern = "-tpm\\.tsv$"
)
tpm_names <- stringr::str_split_i(basename(tpm_files), pattern = "-", i = 1)
names(tpm_files) <- tpm_names


pseudobulk_files <- list.files(
  path = pseudobulk_dir,
  full.names = TRUE,
  pattern = "-pseudobulk\\.tsv$"
)
pseudobulk_names <- stringr::str_split_i(basename(pseudobulk_files), pattern = "-", i = 1)
names(pseudobulk_files) <- pseudobulk_names

# Make sure we have the same projects, in the same order
stopifnot(
  all.equal(names(tpm_files), names(pseudobulk_files))
)
```

### Read and prepare input data

We'll make both a long and wide version of the data for convenience throughout the notebook.


```{r}
project_long_df_list <- purrr::map2(
  tpm_files, 
  pseudobulk_files, 
  \(tpm_file, pseudo_file) {
    
    dplyr::bind_rows(
      # TPM needs to be in log2 space
      readr::read_tsv(tpm_file, show_col_types = FALSE) |>
        dplyr::mutate(expression = log2(expression)),
      readr::read_tsv(pseudo_file, show_col_types = FALSE)
    )
  }
)

# Make a wide version as well
project_wide_df_list <- project_long_df_list |>
  purrr::map(
    \(df) {
      df |>
        tidyr::pivot_wider(names_from = expression_type, values_from = expression)
    }
)
```


## Full distributions

First, we'll visualize distributions of all quantities:

```{r, fig.width = 7, fig.height = 5, warning = FALSE}
ggplot(purrr::list_rbind(project_long_df_list, names_to = "project_id")) + 
  aes(x = expression, fill = expression_type) + 
  geom_density(alpha = 0.5) + 
  scale_fill_brewer(palette = "Dark2") + 
  facet_grid(
    rows = vars(expression_type), 
    cols = vars(project_id),
    scales = "free_y"
  ) +
  theme(legend.position = "none")
```

We see big spikes at zero, not surprisingly.
Due to the different transformation approaches, the `pseudobulk_deseq` version has some negatives for fractional values, but the other quantities have a lower bound of zero.
Bulk TPM has the highest peak at zero by a good amount, followed by `pseudobulk_log_counts` and then `pseudobulk_deseq`.
All around distribution range from their lower bound up to around 20.

## Relationship between quantities


This section will look at the relationship between bulk and pseudobulk quantities with:

* scatterplots to confirm if we have a linear relationship
* per-sample linear models of `bulk ~ pseudobulk` to do a cursory comparison of model statistics
  * these results are presented both as plots and as the full per-sample table to scroll through
  
  
  
## Relationship between quantities

This section will look at the relationship among quantities.

  
### Scatterplots 

First, we'll look at some scatterplots:

* How similar are the pseudobulk measures themselves?
* How does each pseudobulk measure compare to bulk?
  * For these plots, we'll bin data to see the concentration of overlapping points more easily.

In all plots, the red line is `y=x`, and the blue line is the regression line.

#### Compare pseudobulk measures

```{r fig.height=28, fig.width=12, message=FALSE, warning=FALSE}
project_wide_df_list |>
  purrr::imap(
    \(df, project_id) {
      
      ggplot(df) + 
        aes(x = pseudobulk_deseq, y = pseudobulk_log_counts) + 
        geom_point(alpha = 0.2, size = 0.5) + 
        geom_smooth(method = "lm", linewidth = 0.5) +
        geom_abline(linewidth = 0.5, color = "red") + 
        facet_wrap(vars(sample_id), nrow = 5) +
        ggtitle("log_counts ~ deseq") 

    }
  ) |>
  patchwork::wrap_plots(ncol = 1)
```


These quantities are exceptionally similar with these differences:

* Driven by different normalization approaches, genes with very low to zero expression
* In a handful of sampels (1-2 per project), `pseudobulk_log_counts` appears to have a higher proportion of low to zero counts, and throughout has markedly lower values compares to `pseudobulk_deseq`.


#### Compare pseudobulk to bulk

To make sure we get a good view, we'll first make the plots and then show them per project with their plot settings.

```{r}
# Helper function to visualize scatterplots with geom_bin_2d()
make_binned_scatterplots <- function(df, project_id, facet_rows) {
  p1 <- ggplot(df) + 
    aes(x = pseudobulk_deseq, y = bulk_tpm) + 
    geom_bin_2d(bins = 12) + # signal mostly starts to wash out after this
    geom_smooth(method = "lm", alpha = 0.8, linewidth = 0.5) +
    geom_abline(alpha = 0.8, linewidth = 0.5, color = "red") + 
    facet_wrap(vars(sample_id), nrow = facet_rows) +
    ggtitle("bulk_tpm ~ deseq") 
    
  p2 <- ggplot(df) + 
    aes(x = pseudobulk_log_counts, y = bulk_tpm) + 
    geom_bin_2d(bins = 12) +
    geom_smooth(method = "lm", alpha = 0.8, linewidth = 0.5) +
    geom_abline(alpha = 0.8, linewidth = 0.5, color = "red") + 
    facet_wrap(vars(sample_id), nrow = facet_rows) +
    ggtitle("bulk_tpm ~ log_counts") 
      
  print(
    patchwork::wrap_plots(p1, p2, ncol = 2) + patchwork::plot_annotation(title = project_id)
  )
}
```


```{r fig.height = 8, fig.width = 12, message=FALSE, warning=FALSE}
make_binned_scatterplots(
  project_wide_df_list$SCPCP000001, 
  project_id = "SCPCP000001",
  facet_rows = 6
)
```



```{r fig.height = 8, fig.width = 12, message=FALSE, warning=FALSE}
make_binned_scatterplots(
  project_wide_df_list$SCPCP000002, 
  project_id = "SCPCP000002",
  facet_rows = 6
)
```


```{r fig.height = 8, fig.width = 12, message=FALSE, warning=FALSE}
make_binned_scatterplots(
  project_wide_df_list$SCPCP000006, 
  project_id = "SCPCP000006",
  facet_rows = 9
)
```


```{r fig.height = 3, fig.width = 12, message=FALSE, warning=FALSE}
make_binned_scatterplots(
  project_wide_df_list$SCPCP000009, 
  project_id = "SCPCP000009",
  facet_rows = 1
)
```


```{r fig.height = 8, fig.width = 12, message=FALSE, warning=FALSE}
make_binned_scatterplots(
  project_wide_df_list$SCPCP000017, 
  project_id = "SCPCP000017",
  facet_rows = 7
)
```


Points are fairly evenly distributed across the scatterplot, except for a very high concentration of points at `0,0` (and into the negatives for `pseudobulk_deseq`). 


### Statistics 

Let's now get some stats for the comparison between bulk and pseudobulk.
We'll fit a linear model for each sample, and display some quantities below both as boxplots and the full table.

```{r fig.height = 10, fig.width = 12}
# Helper function to plot model statistics from data frame
plot_stats <- function(df, column, title) {
  ggplot(df) + 
    aes(x = expression_type, y = {{column}}, color = expression_type) + 
    geom_boxplot() + 
    scale_color_brewer(palette = "Dark2") +
    ggtitle(title) +
    facet_wrap(vars(project_id), nrow = 1) +
    theme(legend.position = "none")
}

model_samples <- function(id, df) {
  sample_df <- df |>
    dplyr::filter(sample_id == id) 
  
  df_deseq <- sample_df |>
    dplyr::filter(is.finite(pseudobulk_deseq), is.finite(bulk_tpm))
  fit_deseq <- summary(lm(bulk_tpm ~ pseudobulk_deseq, data = df_deseq))

  df_log_counts <- sample_df |>
      dplyr::filter(is.finite(pseudobulk_log_counts), is.finite(bulk_tpm))
  fit_log_counts <- summary(lm(bulk_tpm ~ pseudobulk_log_counts, data = df_log_counts))
      
  # Tabulate and return some fit stats
  data.frame(
    expression_type = c("deseq", "log_counts"),
    rsquared = c(fit_deseq$r.squared, fit_log_counts$r.squared), 
    coeff = c(fit_deseq$coefficients[2], fit_log_counts$coefficients[2]), 
    residual_sd = c(fit_deseq$sigma,  fit_log_counts$sigma)
  )
}

stats_df <- project_wide_df_list |>
  purrr::map(
    \(df) {
      
      # We need to map over sample ids now
      samples <- unique(df$sample_id)
      names(samples) <- samples
      
      fit_table <- samples |>
        purrr::map(model_samples, df) |>
        purrr::list_rbind(names_to = "sample_id")
      
      return(fit_table)

    }
  ) |>
  # now, combine all projects into a single table
  purrr::list_rbind(names_to = "project_id")

patchwork::wrap_plots(
  plot_stats(stats_df, rsquared, "rsquared"),
  plot_stats(stats_df, coeff, "coeff"), 
  plot_stats(stats_df, residual_sd, "residual_sd"), 
  nrow = 3
) 
```

* Pseudobulk quantities are exceptionally similar here, which isn't necessarily surprising given the similarity of the pseudobulk measures
* Relationships are strongest for`SCPCP000001` and `SCPCP000002`, then `SCPCP000006`, and finally `SCPCP000009` and `SCPCP000017`, although `SCPCP00001`, `SCPCP000002`, and `SCPCP000006` do have higher residual sd.
* Samples within a given project have broadly similar coefficients, with a few outliers, suggesting less of an interaction among samples/expression than one might have thought (although how much do the zeros drive this?)

All the actual values are here:


```{r}
stats_df
```


## Disagreeing expression

Next, we'll take a quick look at cases where one modality has zero expression and the other doesn't.
In these cases, if expression is generally high, we have evidence of disagreement/discrepancy between bulk and single-cell that may be interesting to investigate.
In this notebook, we'll just a sense of how much "there is there," and we'll leave the in-depth look into any such genes for a subsequent notebook.

In this section, we'll also use a threshold of `1e-12` for zero here.


### Bulk TPM when single-cell is zero


```{r fig.height=10, fig.width=12, message=FALSE, warning=FALSE}
project_wide_df_list |>
  purrr::map(
    \(df) {
      
      low_deseq <- df |>
        dplyr::filter(pseudobulk_deseq <= 1e-12, 
                      bulk_tpm > 1e-12)
      low_logcounts <- df |>
        dplyr::filter(pseudobulk_log_counts <= 1e-12, 
                      bulk_tpm > 1e-12)  

      
      p1 <- ggplot(low_deseq) + 
        aes(x = sample_id, y = bulk_tpm) + 
        ggforce::geom_sina(size = 0.5) +
        theme(axis.text.x = element_blank()) +
        ggtitle("TPM for zero & negative pesudobulk_deseq")
  
      p2 <- ggplot(low_logcounts) + 
        aes(x = sample_id, y = bulk_tpm) + 
        ggforce::geom_sina(size = 0.5) +
        theme(axis.text.x = element_blank()) +
        ggtitle("TPM for zero pseudobulk_log_counts")
      
      patchwork::wrap_plots(p1, p2, nrow = 1)
    }
  ) |>
  patchwork::wrap_plots(ncol = 1)
```



### Single-cell when bulk TPM is zero

Even though we don't have 1:1 correspondance between pseudobulks here, we'll just consider only points where neither is 0 to get a sense.
This isn't final.

```{r fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
project_wide_df_list |>
  purrr::imap(
    \(df, project_id) {
      
      low_bulk <- df |>
        dplyr::filter(bulk_tpm <= 1e-12, 
                      pseudobulk_deseq> 1e-12, 
                      pseudobulk_log_counts> 1e-12) |>
        tidyr::pivot_longer(
          contains("pseudobulk"), 
          names_to = "expression_type", 
          values_to = "expression"
        )
      
      ggplot(low_bulk) + 
        aes(x = sample_id, y = expression, color = expression_type) + 
        ggforce::geom_sina(size = 0.5) +
        theme(axis.text.x = element_blank()) +
        ggtitle(project_id)

    }
  ) |>
  patchwork::wrap_plots(ncol = 1, guides = "collect")
```



From both comparisons, there are a fair number of genes with high expression in one modality and essentially zero in the other. 
A more careful investigation here look into what exactly these genes are, and whether they have some biological relationship that might suggest modalities are picking up different information.


### Do pseudobulks have strong disagreements?

This will show genes strongly affected by different normalizations.


```{r fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
project_wide_df_list |>
  purrr::imap(
    \(df, project_id) {
      
      different_low_pseudo <- df |>
        dplyr::filter((pseudobulk_deseq> 1e-12 & pseudobulk_log_counts <= 1e-12) |
                       (pseudobulk_deseq <=1e-12 & pseudobulk_log_counts > 1e-12) ) |>
        tidyr::pivot_longer(
          contains("pseudobulk"), 
          names_to = "expression_type", 
          values_to = "expression"
        )
      
      ggplot(different_low_pseudo) + 
        aes(x = sample_id, y = expression, color = expression_type) + 
        ggforce::geom_sina(size = 0.5) +
        theme(axis.text.x = element_blank()) +
        ggtitle(project_id)


    }
  ) |>
  patchwork::wrap_plots(ncol = 1, guides = "collect")
```

Most values seem to be `[-2.5, 2.5]` for both pseudobulks, but some are getting as high as 6-9. 


## Session info

```{r}
sessionInfo()
```